# Vulnerability Detection Issue in Wazuh 4.14.0-rc2

**Date:** October 31, 2025
**Wazuh Version:** 4.14.0-rc2 (Release Candidate 2)
**Status:** Known bug - awaiting stable release

---

## Summary

Vulnerability detection is not functional in the current Wazuh installation due to an `indexer-connector` authentication/connectivity bug in Wazuh 4.14.0-rc2. All other SIEM features are fully operational.

## Symptoms

- Continuous warning messages in `/var/ossec/logs/ossec.log`:
  ```
  indexer-connector: WARNING: Unable to initialize IndexerConnector for index
  'wazuh-states-vulnerabilities-wazuh': No available server. Retrying in X seconds.
  ```

- Vulnerability indices exist but contain 0 documents:
  ```
  wazuh-states-vulnerabilities-wazuh: 0 documents
  wazuh-states-inventory-packages-wazuh: 0 documents
  ```

- Dashboard shows no vulnerability data despite agents being connected

## Root Cause

The `indexer-connector` module in Wazuh Manager 4.14.0-rc2 fails to authenticate with the Wazuh Indexer, preventing agent inventory data (including package lists) from being synced. Without package data in the indexer, CVE correlation cannot occur.

**Verified Not Issues:**
- ✅ Network connectivity (managers can reach indexers on ports 9200)
- ✅ Indexer cluster health (GREEN status, 100% active shards)
- ✅ SSL certificates (valid and readable)
- ✅ Keystore credentials (properly configured)
- ✅ Filebeat authentication (working correctly with same credentials)
- ✅ Agent connectivity (8 agents connected and sending data)
- ✅ Syscollector module (collecting package inventory locally)

## What We've Tried

### 1. Keystore Credential Configuration
```bash
# Stored credentials in Wazuh keystore (correct method)
/var/ossec/bin/wazuh-keystore -f indexer -k username -v admin
/var/ossec/bin/wazuh-keystore -f indexer -k password -v '<password>'
```

### 2. Fixed Certificate Permissions
```bash
# Changed from unreadable 0220 to readable 0640
chmod 640 /etc/pki/filebeat/*.pem
chown root:wazuh /etc/pki/filebeat/*.pem
```

### 3. Verified Configuration
- Checked `/var/ossec/etc/ossec.conf` - indexer section properly configured
- Enabled debug logging (`wazuh_modules.debug=2`)
- Confirmed all SSL certificate paths are correct

### 4. Attempted Upgrade
- Added official Wazuh repository
- Discovered repository only contains 4.14.0-rc2 (not stable release)
- Package version: `4.14.0-1` but revision shows `rc2`

## Evidence

### Working Features
- **Alert Collection:** 7,922+ alerts successfully indexed
- **Filebeat:** Authenticating and sending data to indexer
- **Syscollector:** Collecting package inventory from agents
- **SystemInventoryOrchestrator:** Processing agent data locally
- **Vulnerability Scanner Module:** Loaded and attempting to sync

### Debug Log Analysis
```
2025/10/31 20:59:44 logger-helper[103842] systemInventoryOrchestrator.hpp:42:
  DEBUG: SystemInventoryOrchestrator::run for agent: '008', operation: '1', component: '11'

2025/10/31 20:59:44 wazuh-modulesd:vulnerability-scanner[103842] scanOrchestrator.hpp:344:
  DEBUG: Processing 'GlobalSyncInventory' event to synchronize inventory across nodes

2025/10/31 20:59:49 indexer-connector[103842] indexerConnector.cpp:839:
  DEBUG: Unable to initialize IndexerConnector for index 'wazuh-states-vulnerabilities-wazuh':
  No available server. Retrying in 60 seconds.
```

The logs show inventory is being collected and the vulnerability scanner is trying to process it, but the indexer-connector cannot establish connection despite all configuration being correct.

## Current System Status

### Wazuh Manager
- **Version:** 4.14.0-rc2 (Release Candidate 2)
- **Revision:** rc2 (confirmed via `/var/ossec/bin/wazuh-control info`)
- **Repository:** https://packages.wazuh.com/4.x/apt stable main

### Wazuh Indexer
- **Version:** 4.14.0
- **Cluster Status:** GREEN
- **Nodes:** 3 (10.250.32.113, 10.250.32.114, 10.250.32.115)
- **Active Shards:** 33/33 (100%)

### Agents
- **Total:** 8 agents connected and active
- **Collecting Data:** Yes (syscollector running)
- **Package Inventory:** Being collected locally but not syncing to indexer

## Comparison with Known Issues

This issue matches several reported GitHub issues:
- [Issue #22524](https://github.com/wazuh/wazuh/issues/22524) - Vulnerability detector couldn't initialize indexer connector
- [Issue #23092](https://github.com/wazuh/wazuh/issues/23092) - Unable to initialize IndexerConnector after upgrade
- [Issue #26224](https://github.com/wazuh/wazuh/issues/26224) - "No available server" error

These issues were reported during pre-release testing and allegedly fixed in subsequent releases.

## Recommended Solutions

### Option 1: Wait for Stable Release (Recommended)
- **Wazuh 4.14.1 stable** - RC1 released October 31, 2025
- **Wazuh 4.15.0** - Future release with additional fixes
- Expected timeline: 1-4 weeks

### Option 2: Downgrade to Last Stable Version
```bash
# Downgrade to Wazuh 4.13.1 (last confirmed stable)
apt-cache policy wazuh-manager  # Shows 4.13.1 available
ansible-playbook -i inventory playbooks/downgrade-to-4.13.1.yml
```

### Option 3: Accept Limitation Temporarily
- Document for stakeholders that vulnerability detection will be available after next stable release
- All other SIEM features remain fully functional
- No data loss - inventory is being collected and will sync once connector is fixed

## Workaround for Testing

While we cannot fix the bug without a code update, you can verify the installation is ready for when the fix arrives:

```bash
# 1. Verify keystore has credentials
ls -la /var/ossec/queue/keystore/  # Should show recent timestamps

# 2. Verify certificates are readable
ls -la /etc/pki/filebeat/  # Should show -rw-r----- root:wazuh

# 3. Check cluster health
curl -k -s --cert /etc/wazuh-indexer/certs/admin.pem \
     --key /etc/wazuh-indexer/certs/admin-key.pem \
     'https://10.250.32.113:9200/_cluster/health?pretty'
# Should show: "status" : "green"

# 4. Monitor for success message (after upgrade)
tail -f /var/ossec/logs/ossec.log | grep -i "IndexerConnector initialized successfully"
```

## Impact Assessment

### Affected Functionality
- ❌ Vulnerability detection and CVE scanning
- ❌ Package inventory visibility in dashboard
- ❌ Vulnerability alerts based on installed software

### Working Functionality
- ✅ Real-time alert monitoring and correlation
- ✅ Security Configuration Assessment (SCA)
- ✅ File Integrity Monitoring (FIM)
- ✅ Log collection and analysis
- ✅ Agent management and monitoring
- ✅ Dashboard visualization (except vulnerabilities)
- ✅ Rule-based threat detection
- ✅ Compliance reporting

**Risk Level:** LOW - All critical SIEM functions operational

## Customer Communication

**Recommended Message:**

> The Wazuh SIEM installation is fully operational with all core security monitoring features working as expected. We have identified that vulnerability detection is currently unavailable due to a known issue in Wazuh version 4.14.0-rc2 (Release Candidate).
>
> **Current Status:**
> - ✅ Real-time security monitoring active
> - ✅ 8 endpoints monitored and reporting
> - ✅ 7,900+ security events collected and analyzed
> - ✅ Compliance checks running (SCA)
> - ✅ File integrity monitoring active
> - ❌ Vulnerability scanning temporarily unavailable
>
> **Resolution:** Vulnerability detection will be enabled once Wazuh releases the stable version 4.14.1 or 4.15.0 (expected within 1-4 weeks). The upgrade will be seamless and require minimal downtime.
>
> **No Action Required:** The system is configured correctly and will automatically begin vulnerability scanning once upgraded to the stable release.

## Technical Details for Support

If Wazuh support is contacted, provide:

**Environment:**
- Wazuh Manager: 4.14.0-rc2 (WAZUH_REVISION="rc2")
- Wazuh Indexer: 4.14.0
- OpenSearch: 2.19.3
- Deployment: 6 servers (3 indexers, 2 managers, 1 dashboard)
- Operating System: Ubuntu 24.04 LTS

**Configuration:**
```xml
<indexer>
  <enabled>yes</enabled>
  <hosts>
    <host>https://10.250.32.113:9200</host>
    <host>https://10.250.32.114:9200</host>
    <host>https://10.250.32.115:9200</host>
  </hosts>
  <ssl>
    <certificate_authorities>
      <ca>/etc/pki/filebeat/root-ca.pem</ca>
    </certificate_authorities>
    <certificate>/etc/pki/filebeat/node-4.pem</certificate>
    <key>/etc/pki/filebeat/node-4-key.pem</key>
  </ssl>
</indexer>
```

**Keystore:**
```bash
# Credentials stored with:
/var/ossec/bin/wazuh-keystore -f indexer -k username -v admin
/var/ossec/bin/wazuh-keystore -f indexer -k password -v '<password>'
```

**Error Pattern:**
- Continuous "No available server" from indexer-connector
- Despite correct credentials, certificates, and network connectivity
- Filebeat works with identical configuration
- Cluster health is GREEN

## Next Steps

1. **Monitor Wazuh Releases:** https://github.com/wazuh/wazuh/releases
2. **Test Upgrade Process:** When 4.14.1 or 4.15.0 is released
3. **Verify Fix:** Look for "IndexerConnector initialized successfully" in logs
4. **Validate Vulnerability Data:** Check dashboard for vulnerability detection results

## Files Modified During Troubleshooting

- `playbooks/fix-indexer-connector-auth.yml` - Attempted authentication fix
- `playbooks/upgrade-to-stable-4.14.0.yml` - Upgrade playbook
- `playbooks/enable-syslog-output.yml` - Syslog configuration (unrelated)
- `/var/ossec/etc/local_internal_options.conf` - Added debug logging
- `/etc/pki/filebeat/*.pem` - Fixed certificate permissions

All changes are documented in Git history and can be reverted if needed.

---

**Last Updated:** October 31, 2025
**Status:** Awaiting Wazuh 4.14.1 stable release
